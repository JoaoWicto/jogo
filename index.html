<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Shadow Survival: Eternal Requiem - ULTRA V6.0</title>
    <style>
        /* --- CSS RESET & VARI√ÅVEIS GLOBAIS --- */
        :root {
            --red: #ff3e3e; 
            --gold: #ffd700; 
            --cyan: #00f2ff; 
            --xp: #3b82f6; 
            --purple: #a333ff;
            --green: #2ecc71;
            --dark: #050508; 
            --panel: rgba(12, 12, 18, 0.95); 
            --panel-light: rgba(255, 255, 255, 0.05);
            --border: rgba(255, 255, 255, 0.15);
            --font-main: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            --font-mono: 'Courier New', Courier, monospace;
        }

        * { 
            box-sizing: border-box; 
            outline: none; 
            -webkit-tap-highlight-color: transparent;
            user-select: none;
        }

        html, body { 
            margin: 0; 
            padding: 0; 
            background: #000; 
            overflow: hidden; 
            font-family: var(--font-main); 
            color: white; 
            width: 100%;
            height: 100%;
            touch-action: none; /* Impede zoom e scroll nativo */
        }

        canvas { 
            display: block; 
            image-rendering: pixelated; /* Estilo retr√¥ n√≠tido */
        }

        /* --- EFEITOS DE TELA (POST-PROCESSING CSS) --- */
        #screen-fx {
            position: fixed; 
            inset: 0; 
            pointer-events: none; 
            z-index: 900;
            background: radial-gradient(circle, transparent 30%, rgba(0,0,0,0.6) 100%);
            box-shadow: inset 0 0 100px rgba(0,0,0,0.8);
        }

        .scanlines {
            position: fixed; 
            inset: 0; 
            pointer-events: none; 
            z-index: 901;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.1) 50%);
            background-size: 100% 4px; 
            opacity: 0.3;
        }

        .vignette {
            position: fixed;
            inset: 0;
            pointer-events: none;
            z-index: 902;
            background: radial-gradient(circle, rgba(0,0,0,0) 60%, rgba(0,0,0,0.9) 100%);
        }

        /* --- INTERFACE (HUD) --- */
        #hud {
            position: fixed; 
            inset: 0; 
            pointer-events: none; 
            padding: 20px;
            z-index: 100; 
            display: flex; 
            flex-direction: column; 
            justify-content: space-between;
        }

        /* Topo do HUD */
        .hud-top { 
            display: flex; 
            justify-content: space-between; 
            align-items: flex-start; 
            width: 100%;
        }

        .player-card {
            width: 340px; 
            background: var(--panel); 
            border: 1px solid var(--border);
            border-left: 4px solid var(--cyan);
            padding: 15px; 
            border-radius: 6px; 
            backdrop-filter: blur(10px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            transition: transform 0.2s;
        }

        .bioma-indicator {
            font-size: 11px; 
            text-transform: uppercase; 
            letter-spacing: 3px;
            color: var(--gold); 
            margin-bottom: 12px; 
            font-weight: 800;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.3);
            display: flex;
            justify-content: space-between;
        }

        .hud-btn-small {
            pointer-events: auto;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            color: white;
            font-size: 9px;
            padding: 2px 6px;
            cursor: pointer;
            border-radius: 3px;
        }
        .hud-btn-small:hover { background: white; color: black; }

        /* Barras de Status */
        .bar-wrap { margin-bottom: 8px; position: relative; }
        .bar-label {
            font-size: 10px; 
            text-transform: uppercase; 
            letter-spacing: 1px;
            margin-bottom: 3px; 
            display: flex; 
            justify-content: space-between;
            font-weight: 700;
            text-shadow: 1px 1px 2px black;
        }

        .bar-bg { 
            height: 10px; 
            background: rgba(0,0,0,0.7); 
            border-radius: 20px; 
            overflow: hidden;
            border: 1px solid rgba(255,255,255,0.1);
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.5);
        }

        .bar-fill { 
            height: 100%; 
            width: 100%; 
            transition: width 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
        }
        /* Brilho na barra */
        .bar-fill::after {
            content: ''; position: absolute; top: 0; left: 0; right: 0; height: 50%;
            background: linear-gradient(to bottom, rgba(255,255,255,0.2), transparent);
        }

        /* Status Num√©ricos (Direita) */
        .stats-grid { 
            display: flex; 
            gap: 10px; 
            flex-direction: column;
            align-items: flex-end;
        }
        .stat-item {
            background: var(--panel); 
            border: 1px solid var(--border);
            padding: 8px 15px; 
            min-width: 110px; 
            text-align: right; 
            border-radius: 4px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        .stat-item label { 
            display: block; 
            font-size: 9px; 
            opacity: 0.6; 
            margin-bottom: 2px; 
            letter-spacing: 1px;
            text-transform: uppercase;
        }
        .stat-item span { 
            font-size: 20px; 
            font-weight: 900; 
            color: var(--gold); 
            font-family: var(--font-mono);
        }

        /* Barra do Boss */
        #boss-hud {
            position: fixed;
            top: 80px;
            left: 50%;
            transform: translateX(-50%);
            width: 60%;
            z-index: 101;
            pointer-events: none;
            opacity: 0;
            transition: opacity 1s;
        }
        #boss-hud.visible { opacity: 1; }
        
        .boss-name-plate {
            text-align: center;
            font-size: 14px;
            color: #ff3e3e;
            letter-spacing: 5px;
            font-weight: 900;
            margin-bottom: 5px;
            text-shadow: 0 0 10px #ff0000;
        }

        /* Dock de Habilidades */
        #skill-dock {
            position: fixed; 
            bottom: 30px; 
            left: 50%; 
            transform: translateX(-50%);
            display: flex; 
            gap: 15px; 
            pointer-events: auto;
            z-index: 110;
        }
        .skill-slot {
            width: 64px; 
            height: 64px; 
            background: var(--panel); 
            border: 1px solid var(--border);
            border-radius: 12px; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            font-size: 10px; 
            font-weight: bold; 
            color: var(--cyan);
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
        }
        .skill-slot:hover { border-color: var(--cyan); transform: translateY(-3px); }
        .skill-slot:active { transform: translateY(1px) scale(0.95); }
        .skill-slot.cooldown { filter: grayscale(1); opacity: 0.6; cursor: not-allowed; }
        .skill-slot.cooldown::after {
            content: ''; position: absolute; inset: 0; background: rgba(0,0,0,0.5);
        }
        .skill-icon { font-size: 24px; margin-bottom: 2px; }
        .skill-key { 
            position: absolute; top: 2px; left: 4px; 
            font-size: 8px; color: rgba(255,255,255,0.5); 
        }

        /* --- MENUS E OVERLAYS --- */
        .overlay {
            position: fixed; 
            inset: 0; 
            background: rgba(5, 5, 8, 0.96);
            backdrop-filter: blur(5px);
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center;
            z-index: 2000; 
            transition: opacity 0.4s, visibility 0.4s;
            padding: 20px;
        }
        .overlay.hidden { opacity: 0; visibility: hidden; pointer-events: none; }

        h1.title {
            font-size: clamp(40px, 8vw, 100px); 
            color: var(--red); 
            letter-spacing: 15px; 
            margin: 0; 
            text-shadow: 0 0 40px rgba(255, 62, 62, 0.6);
            text-transform: uppercase;
            font-weight: 900;
        }
        p.subtitle {
            letter-spacing: 6px; 
            margin-bottom: 40px; 
            opacity: 0.7; 
            font-size: 14px; 
            color: var(--gold);
        }

        /* Bot√µes Gen√©ricos */
        .btn-action {
            background: linear-gradient(45deg, rgba(255,255,255,0.05), rgba(255,255,255,0.1)); 
            border: 1px solid var(--border); 
            color: #fff;
            padding: 16px 50px; 
            font-size: 16px; 
            font-weight: 800; 
            cursor: pointer;
            text-transform: uppercase; 
            letter-spacing: 3px; 
            transition: all 0.3s;
            margin: 10px;
            border-radius: 4px;
            position: relative;
            overflow: hidden;
        }
        .btn-action::before {
            content: ''; position: absolute; top: 0; left: -100%; width: 100%; height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: 0.5s;
        }
        .btn-action:hover::before { left: 100%; }
        .btn-action:hover { 
            background: #fff; 
            color: #000; 
            box-shadow: 0 0 30px rgba(255,255,255,0.5); 
            transform: translateY(-2px);
        }

        /* Layout de Grades (Cards) */
        .cards-container {
            display: flex; 
            flex-wrap: wrap; 
            justify-content: center; 
            gap: 20px;
            max-width: 1000px;
        }

        .card-item {
            width: 260px;
            background: rgba(255,255,255,0.03); 
            border: 1px solid var(--border);
            padding: 25px; 
            border-radius: 8px; 
            cursor: pointer; 
            transition: 0.3s;
            text-align: center;
            position: relative;
        }
        .card-item:hover { 
            background: rgba(255,255,255,0.08); 
            border-color: var(--cyan);
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,242,255,0.1);
        }
        .card-item h3 { margin: 0 0 10px 0; color: var(--gold); letter-spacing: 1px; font-size: 16px; }
        .card-item p { font-size: 12px; opacity: 0.7; margin-bottom: 15px; line-height: 1.4; }
        .card-price { 
            display: block; 
            margin-top: 10px; 
            font-size: 14px; 
            color: var(--purple); 
            font-weight: bold; 
        }

        /* Menu de Loja */
        #menu-shop .shop-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 15px;
            width: 100%;
            max-width: 1100px;
            max-height: 60vh;
            overflow-y: auto;
            padding: 10px;
            scrollbar-width: thin;
            scrollbar-color: var(--cyan) #111;
        }

        /* Menu de Configura√ß√µes */
        .settings-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            max-width: 400px;
            margin-bottom: 20px;
            background: rgba(255,255,255,0.05);
            padding: 15px;
            border-radius: 4px;
        }
        .settings-row label { font-size: 14px; font-weight: bold; }
        input[type=range] { width: 150px; cursor: pointer; }

        /* --- NOTIFICA√á√ïES (TOAST) --- */
        #toast {
            position: fixed; 
            top: 15%; 
            left: 50%; 
            transform: translate(-50%, -50%);
            font-size: 24px; 
            font-weight: 800; 
            color: #fff; 
            pointer-events: none; 
            z-index: 5000;
            text-shadow: 0 0 20px rgba(0,0,0,1); 
            background: rgba(0,0,0,0.7);
            padding: 10px 30px;
            border-radius: 50px;
            border: 1px solid rgba(255,255,255,0.2);
            opacity: 0;
            transition: opacity 0.3s;
            text-align: center;
            letter-spacing: 2px;
            white-space: nowrap;
        }

        /* --- CONTROLES MOBILE --- */
        .mobile-controls {
            display: none; /* Ativado via JS se for touch */
            position: fixed;
            inset: 0;
            pointer-events: none;
            z-index: 500;
        }
        
        /* Joystick Esquerdo */
        #joy-zone-left {
            position: absolute;
            bottom: 40px;
            left: 40px;
            width: 150px;
            height: 150px;
            background: rgba(255, 255, 255, 0.05);
            border: 2px dashed rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            pointer-events: auto;
            touch-action: none;
        }
        #joy-stick {
            position: absolute;
            top: 50%; left: 50%;
            width: 60px; height: 60px;
            margin-left: -30px; margin-top: -30px;
            background: radial-gradient(circle, #fff, #ccc);
            border-radius: 50%;
            opacity: 0.5;
            box-shadow: 0 0 20px rgba(255,255,255,0.3);
            pointer-events: none;
            transform: translate(0,0);
        }

        /* Bot√£o de Ataque Direito */
        #btn-attack-zone {
            position: absolute;
            bottom: 60px;
            right: 60px;
            width: 100px;
            height: 100px;
            background: rgba(255, 62, 62, 0.1);
            border: 2px solid rgba(255, 62, 62, 0.3);
            border-radius: 50%;
            pointer-events: auto;
            display: flex;
            align-items: center;
            justify-content: center;
            color: rgba(255,255,255,0.5);
            font-weight: bold;
            font-size: 14px;
            touch-action: none;
        }
        #btn-attack-zone:active {
            background: rgba(255, 62, 62, 0.4);
            transform: scale(0.95);
        }

        /* Bot√£o da Loja no HUD */
        #btn-shop-hud {
            pointer-events: auto;
            background: var(--purple);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            font-weight: bold;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 10px;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: 0.2s;
            box-shadow: 0 0 10px var(--purple);
        }
        #btn-shop-hud:hover { transform: scale(1.05); filter: brightness(1.2); }

        /* Floater Text (Dano) */
        .floater {
            position: absolute;
            font-weight: 900;
            pointer-events: none;
            animation: floatUp 0.8s forwards;
            font-size: 20px;
            text-shadow: 1px 1px 0 #000;
        }
        @keyframes floatUp {
            0% { transform: translateY(0) scale(1); opacity: 1; }
            100% { transform: translateY(-40px) scale(1.5); opacity: 0; }
        }

    </style>
</head>
<body>

    <!-- √Åudio do Sistema -->
    <audio id="bgm" loop>
        <!-- Coloque seu link aqui. Exemplo placeholder -->
        <source src="https://opengameart.org/sites/default/files/The%20Dark%20Amulet.mp3" type="audio/mpeg">
    </audio>

    <!-- Camadas FX -->
    <div id="screen-fx"></div>
    <div class="scanlines"></div>
    <div class="vignette"></div>
    
    <!-- Container de Texto Flutuante -->
    <div id="floaters-container" style="position:fixed; inset:0; pointer-events:none; z-index:90;"></div>

    <!-- Notifica√ß√µes -->
    <div id="toast">SISTEMA INICIADO</div>

    <!-- Canvas do Jogo -->
    <canvas id="game-canvas"></canvas>

    <!-- Controles Mobile -->
    <div class="mobile-controls" id="mobile-ui">
        <div id="joy-zone-left"><div id="joy-stick"></div></div>
        <div id="btn-attack-zone">ATACAR</div>
    </div>

    <!-- Interface HUD -->
    <div id="hud">
        <div class="hud-top">
            <div class="player-card">
                <div class="bioma-indicator">
                    <span id="bioma-name">---</span>
                    <button class="hud-btn-small" onclick="Engine.toggleSettings()">CONFIG</button>
                </div>
                
                <div class="bar-wrap">
                    <div class="bar-label">XP N√çVEL <span id="lvl-txt">1</span> <span id="xp-val">0/100</span></div>
                    <div class="bar-bg"><div id="xp-bar" class="bar-fill" style="background: var(--xp); width: 0%"></div></div>
                </div>

                <div class="bar-wrap">
                    <div class="bar-label" style="color: var(--red);">VITALIDADE <span id="hp-val">100/100</span></div>
                    <div class="bar-bg"><div id="hp-bar" class="bar-fill" style="background: var(--red);"></div></div>
                </div>

                <div class="bar-wrap">
                    <div class="bar-label" style="color: var(--cyan);">MANA <span id="mp-val">100/100</span></div>
                    <div class="bar-bg"><div id="mp-bar" class="bar-fill" style="background: var(--cyan);"></div></div>
                </div>
            </div>

            <div class="stats-grid">
                <div class="stat-item"><label>ABATES</label><span id="kills-txt">0</span></div>
                <div class="stat-item"><label>ALMAS</label><span id="coins-txt">0</span></div>
                <button id="btn-shop-hud" onclick="Engine.toggleShop()">MERCADOR [B]</button>
            </div>
        </div>

        <div id="boss-hud">
            <div class="boss-name-plate" id="boss-name">BOSS NAME</div>
            <div class="bar-bg" style="height: 15px; border: 2px solid rgba(255,255,255,0.3);">
                <div id="boss-bar" class="bar-fill" style="background: linear-gradient(90deg, #800000, #ff0000);"></div>
            </div>
        </div>

        <div id="skill-dock">
            <div class="skill-slot" onclick="Engine.cast(1)">
                <div class="skill-icon">üí•</div>
                <span class="skill-key">[1]</span>
            </div>
            <div class="skill-slot" onclick="Engine.cast(2)">
                <div class="skill-icon">‚ö°</div>
                <span class="skill-key">[2]</span>
            </div>
            <div class="skill-slot" onclick="Engine.cast(3)">
                <div class="skill-icon">üíñ</div>
                <span class="skill-key">[3]</span>
            </div>
            <div class="skill-slot" onclick="Engine.cast(4)">
                <div class="skill-icon">üåÄ</div>
                <span class="skill-key">[4]</span>
            </div>
            <div class="skill-slot" onclick="Engine.cast(5)">
                <div class="skill-icon">üíÄ</div>
                <span class="skill-key">[5]</span>
            </div>
        </div>
    </div>

    <!-- MENU INICIAL -->
    <div id="menu-start" class="overlay">
        <h1 class="title">SHADOW</h1>
        <p class="subtitle">ETERNAL REQUIEM ‚Ä¢ ULTRA V6.0</p>
        
        <div class="cards-container">
            <div class="card-item" onclick="Engine.startGame('blade')">
                <div style="font-size: 40px; margin-bottom: 10px;">üó°Ô∏è</div>
                <h3>L√ÇMINA SANGRENTA</h3>
                <p>Combate pr√≥ximo, r√°pido e letal. Rouba vida ao matar.</p>
                <span style="color: var(--red); font-weight: bold;">[INICIAR]</span>
            </div>
            <div class="card-item" onclick="Engine.startGame('staff')">
                <div style="font-size: 40px; margin-bottom: 10px;">üîÆ</div>
                <h3>CAJADO DO VAZIO</h3>
                <p>Ataques em √°rea massivos e alta regenera√ß√£o de mana.</p>
                <span style="color: var(--cyan); font-weight: bold;">[INICIAR]</span>
            </div>
        </div>
        
        <div style="margin-top: 30px;">
            <button class="btn-action" style="padding: 10px 30px; font-size: 12px;" onclick="Engine.toggleSettings()">CONFIGURA√á√ïES</button>
        </div>
    </div>

    <!-- MENU LEVEL UP -->
    <div id="menu-upgrade" class="overlay hidden">
        <h2 style="font-size: 30px; color: var(--gold); margin-bottom: 10px; letter-spacing: 5px;">ASCENS√ÉO DIVINA</h2>
        <p style="margin-bottom: 30px; opacity: 0.7;">ESCOLHA UMA B√äN√á√ÉO</p>
        <div class="cards-container" id="upgrade-root"></div>
    </div>

    <!-- MENU LOJA -->
    <div id="menu-shop" class="overlay hidden">
        <h2 style="font-size: 30px; color: var(--purple); margin-bottom: 10px; letter-spacing: 5px;">MERCADOR DE √âTER</h2>
        <p style="margin-bottom: 20px; opacity: 0.7;">TROQUE ALMAS POR PODER</p>
        <div class="shop-grid" id="shop-root">
            <!-- Itens gerados via JS -->
        </div>
        <button class="btn-action" style="margin-top: 20px; border-color: var(--red);" onclick="Engine.toggleShop()">FECHAR LOJA</button>
    </div>

    <!-- MENU CONFIGURA√á√ïES -->
    <div id="menu-settings" class="overlay hidden">
        <h2 style="color: white; margin-bottom: 30px;">CONFIGURA√á√ïES</h2>
        
        <div class="settings-row">
            <label>Tamanho do Joystick</label>
            <input type="range" min="100" max="250" value="150" oninput="Engine.resizeJoystick(this.value)">
        </div>

        <div class="settings-row">
            <label>Volume M√∫sica</label>
            <input type="range" min="0" max="100" value="50" oninput="Engine.setVolume(this.value)">
        </div>

        <button class="btn-action" onclick="Engine.toggleFullscreen()">TELA CHEIA</button>
        <button class="btn-action" onclick="Engine.toggleSettings()">VOLTAR</button>
    </div>

    <!-- GAME OVER -->
    <div id="menu-death" class="overlay hidden">
        <h2 style="font-size: 60px; color: var(--red); letter-spacing: 10px; text-shadow: 0 0 30px red;">O RITUAL FALHOU</h2>
        <p id="death-stats" style="font-size: 18px; opacity: 0.8; margin-bottom: 40px;"></p>
        <button class="btn-action" onclick="location.reload()">RENASCER</button>
    </div>

<script>
/** * SHADOW SURVIVAL: ETERNAL REQUIEM 
 * ENGINE CORE V6.0 - ULTRA EDITION
 * Author: Gemini
 */

// --- MATH UTILS ---
const MathUtils = {
    rand: (min, max) => Math.random() * (max - min) + min,
    randInt: (min, max) => Math.floor(Math.random() * (max - min + 1)) + min,
    dist: (x1, y1, x2, y2) => Math.hypot(x2 - x1, y2 - y1),
    lerp: (start, end, amt) => (1 - amt) * start + amt * end,
    clamp: (num, min, max) => Math.min(Math.max(num, min), max)
};

// --- CONFIGURA√á√ÉO GLOBAL ---
const CONFIG = {
    PARTICLE_LIMIT: 200,
    ENEMY_LIMIT: 60,
    SPAWN_RADIUS: 900,
    DESPAWN_RADIUS: 1400,
    BIOMES: [
        { name: "Cemit√©rio de √âter", bg: "#08080a", fog: "#000", accent: "#ff3e3e" },
        { name: "Pantanal T√≥xico", bg: "#050f05", fog: "#020", accent: "#2ecc71" },
        { name: "Deserto de Sangue", bg: "#140505", fog: "#200", accent: "#ffaa00" },
        { name: "Vazio Astral", bg: "#020208", fog: "#002", accent: "#00f2ff" },
        { name: "Reino de Obsidiana", bg: "#000000", fog: "#111", accent: "#ffffff" }
    ],
    SHOP_ITEMS: [
        { id: 'pot_hp', name: 'Elixir Vital', desc: 'Recupera 50% HP', cost: 100, type: 'consumable', fn: (p) => { p.hp = Math.min(p.maxHp, p.hp + p.maxHp*0.5); } },
        { id: 'up_dmg', name: 'Pedra de Amolar', desc: 'Dano Base +5', cost: 250, type: 'passive', fn: (p) => { p.dmg += 5; } },
        { id: 'up_spd', name: 'Botas de Hermes', desc: 'Velocidade +5%', cost: 300, type: 'passive', fn: (p) => { p.speed *= 1.05; } },
        { id: 'up_reg', name: 'Anel Lunar', desc: 'Regen Mana +0.05', cost: 400, type: 'passive', fn: (p) => { p.stats.regenMp += 0.05; } },
        { id: 'up_maxhp', name: 'Cora√ß√£o de Tit√£', desc: 'Vida M√°x +50', cost: 500, type: 'passive', fn: (p) => { p.maxHp += 50; p.hp += 50; } },
        { id: 'up_thorns', name: 'Armadura de Espinhos', desc: 'Reflete 10% Dano', cost: 600, type: 'passive', fn: (p) => { p.stats.thorns += 0.1; } },
        { id: 'up_luck', name: 'Trevo Dourado', desc: 'Sorte +10%', cost: 800, type: 'passive', fn: (p) => { p.stats.luck += 0.1; } }
    ]
};

// --- ENGINE PRINCIPAL ---
const Engine = (() => {
    const canvas = document.getElementById("game-canvas");
    const ctx = canvas.getContext("2d");
    
    // Vari√°veis de Estado
    let width, height;
    let loopId;
    let frame = 0;
    
    // √Åudio
    const bgm = document.getElementById("bgm");

    const world = {
        camera: { x: 0, y: 0, tx: 0, ty: 0, shake: 0 },
        entities: [], // Inimigos
        particles: [],
        drops: [],
        decals: [], // Sangue no ch√£o
        floaters: [] // Texto flutuante
    };

    const state = {
        running: false,
        paused: false,
        level: 1,
        xp: 0,
        nextXp: 100,
        kills: 0,
        souls: 0,
        biomeIdx: 0,
        difficulty: 1.0,
        bossActive: false
    };

    const player = {
        x: 0, y: 0,
        radius: 16,
        color: '#fff',
        speed: 4.5,
        angle: 0,
        hp: 100, maxHp: 100,
        mp: 100, maxMp: 100,
        dmg: 30,
        weapon: 'blade',
        invul: 0, // Frames invulner√°vel
        cd_atk: 0, // Cooldown ataque
        stats: {
            area: 1.0,
            magnet: 150,
            regenMp: 0.1,
            lifesteal: 0,
            thorns: 0,
            luck: 1.0
        }
    };

    // Inputs
    const keys = {};
    const joy = { active: false, x: 0, y: 0, id: null };
    const attackBtn = { active: false, id: null };

    // --- CLASSES --- //

    class Enemy {
        constructor(x, y, type) {
            this.x = x; this.y = y;
            this.type = type;
            this.dead = false;
            this.frozen = 0;
            this.pushX = 0; this.pushY = 0;
            
            // Stats baseados no tipo
            const diff = state.difficulty;
            if (type === 'boss') {
                this.hp = 5000 * diff;
                this.maxHp = this.hp;
                this.dmg = 40 * diff;
                this.speed = 2.8;
                this.radius = 60;
                this.color = '#fff';
                this.xp = 1000;
                this.souls = 500;
            } else if (type === 'tank') {
                this.hp = 150 * diff;
                this.maxHp = this.hp;
                this.dmg = 20 * diff;
                this.speed = 1.5;
                this.radius = 30;
                this.color = '#888';
                this.xp = 30;
                this.souls = 10;
            } else if (type === 'runner') {
                this.hp = 40 * diff;
                this.maxHp = this.hp;
                this.dmg = 10 * diff;
                this.speed = 4.0;
                this.radius = 12;
                this.color = CONFIG.BIOMES[state.biomeIdx].accent;
                this.xp = 15;
                this.souls = 5;
            } else { // grunt
                this.hp = 80 * diff;
                this.maxHp = this.hp;
                this.dmg = 15 * diff;
                this.speed = 2.5 + Math.random();
                this.radius = 18;
                this.color = '#b33';
                this.xp = 10;
                this.souls = 2;
            }
        }

        update() {
            // Empurr√£o
            this.x += this.pushX; this.y += this.pushY;
            this.pushX *= 0.8; this.pushY *= 0.8;

            if (this.frozen > 0) { this.frozen--; return; }

            const ang = Math.atan2(player.y - this.y, player.x - this.x);
            this.x += Math.cos(ang) * this.speed;
            this.y += Math.sin(ang) * this.speed;

            // Colis√£o Player
            const d = MathUtils.dist(this.x, this.y, player.x, player.y);
            if (d < this.radius + player.radius) {
                Engine.damagePlayer(this.dmg);
                // Dano de Espinhos
                if (player.stats.thorns > 0 && player.invul > 30) {
                    Engine.damageEnemy(this, this.dmg * player.stats.thorns);
                }
            }
        }

        draw(ctx, cam) {
            const rx = this.x - cam.x;
            const ry = this.y - cam.y;

            // Sombra
            ctx.fillStyle = 'rgba(0,0,0,0.5)';
            ctx.beginPath(); ctx.ellipse(rx, ry + this.radius*0.8, this.radius, this.radius*0.4, 0, 0, Math.PI*2); ctx.fill();

            // Corpo
            ctx.fillStyle = this.frozen > 0 ? '#0ff' : this.color;
            ctx.beginPath(); ctx.arc(rx, ry, this.radius, 0, Math.PI*2); ctx.fill();

            // Barra HP Inimigo (apenas se machucado)
            if (this.hp < this.maxHp && this.type !== 'boss') {
                const pct = this.hp / this.maxHp;
                ctx.fillStyle = '#300';
                ctx.fillRect(rx - 15, ry - this.radius - 8, 30, 4);
                ctx.fillStyle = '#f00';
                ctx.fillRect(rx - 15, ry - this.radius - 8, 30 * pct, 4);
            }
        }
    }

    class Particle {
        constructor(x, y, color, speed, life) {
            this.x = x; this.y = y;
            const a = Math.random() * Math.PI * 2;
            this.vx = Math.cos(a) * speed;
            this.vy = Math.sin(a) * speed;
            this.life = life;
            this.maxLife = life;
            this.color = color;
            this.size = MathUtils.rand(2, 5);
        }
        update() {
            this.x += this.vx; this.y += this.vy;
            this.life--;
            this.vx *= 0.95; this.vy *= 0.95;
            this.size *= 0.96;
        }
        draw(ctx, cam) {
            ctx.globalAlpha = this.life / this.maxLife;
            ctx.fillStyle = this.color;
            ctx.fillRect(this.x - cam.x, this.y - cam.y, this.size, this.size);
            ctx.globalAlpha = 1;
        }
    }

    // --- FUN√á√ïES DE SISTEMA --- //

    function resize() {
        width = canvas.width = window.innerWidth;
        height = canvas.height = window.innerHeight;
    }

    function initInput() {
        window.addEventListener('keydown', e => {
            keys[e.code] = true;
            if(e.code === 'KeyB') toggleShop();
            if(e.key >= '1' && e.key <= '5') castSkill(parseInt(e.key));
        });
        window.addEventListener('keyup', e => keys[e.code] = false);

        // Mobile Touch (Multitouch)
        const joyZone = document.getElementById('joy-zone-left');
        const atkZone = document.getElementById('btn-attack-zone');

        if ('ontouchstart' in window) {
            document.getElementById('mobile-ui').style.display = 'block';
            
            // Joystick Touch
            joyZone.addEventListener('touchstart', e => {
                e.preventDefault();
                for(let i=0; i<e.changedTouches.length; i++){
                    joy.id = e.changedTouches[i].identifier;
                    joy.active = true;
                    updateJoy(e.changedTouches[i]);
                }
            });

            joyZone.addEventListener('touchmove', e => {
                e.preventDefault();
                for(let i=0; i<e.changedTouches.length; i++){
                    if(e.changedTouches[i].identifier === joy.id) updateJoy(e.changedTouches[i]);
                }
            });

            const endJoy = (e) => {
                for(let i=0; i<e.changedTouches.length; i++){
                    if(e.changedTouches[i].identifier === joy.id) {
                        joy.active = false;
                        joy.x = 0; joy.y = 0;
                        document.getElementById('joy-stick').style.transform = `translate(0px, 0px)`;
                    }
                }
            };
            joyZone.addEventListener('touchend', endJoy);
            joyZone.addEventListener('touchcancel', endJoy);

            // Attack Button Touch
            atkZone.addEventListener('touchstart', e => {
                e.preventDefault();
                attackBtn.active = true;
                performAttack(); // Ataque imediato no toque
            });
            atkZone.addEventListener('touchend', e => { e.preventDefault(); attackBtn.active = false; });
        }
    }

    function updateJoy(touch) {
        const rect = document.getElementById('joy-zone-left').getBoundingClientRect();
        const cx = rect.left + rect.width/2;
        const cy = rect.top + rect.height/2;
        const dx = touch.clientX - cx;
        const dy = touch.clientY - cy;
        const dist = Math.min(Math.hypot(dx, dy), rect.width/2);
        const ang = Math.atan2(dy, dx);
        
        joy.x = Math.cos(ang) * (dist / (rect.width/2));
        joy.y = Math.sin(ang) * (dist / (rect.width/2));
        
        const stickX = Math.cos(ang) * dist;
        const stickY = Math.sin(ang) * dist;
        document.getElementById('joy-stick').style.transform = `translate(${stickX}px, ${stickY}px)`;
    }

    function startGame(weaponClass) {
        document.getElementById("menu-start").classList.add("hidden");
        state.running = true;
        state.paused = false;
        
        // Setup Player
        player.weapon = weaponClass;
        if(weaponClass === 'staff') {
            player.maxMp = 150; player.mp = 150;
            player.dmg = 50;
            player.stats.regenMp = 0.3;
        } else {
            player.speed = 5.0;
            player.stats.lifesteal = 2;
        }
        
        // Setup Music
        bgm.volume = 0.5;
        bgm.play().catch(e => console.log("√Åudio bloqueado pelo browser at√© intera√ß√£o"));

        loopId = requestAnimationFrame(gameLoop);
    }

    // --- GAME LOOP --- //

    function gameLoop() {
        if(!state.paused && state.running) {
            update();
            draw();
            frame++;
        }
        loopId = requestAnimationFrame(gameLoop);
    }

    function update() {
        // --- PLAYER MOVEMENT ---
        let mx = 0, my = 0;
        if (keys['KeyW'] || keys['ArrowUp']) my -= 1;
        if (keys['KeyS'] || keys['ArrowDown']) my += 1;
        if (keys['KeyA'] || keys['ArrowLeft']) mx -= 1;
        if (keys['KeyD'] || keys['ArrowRight']) mx += 1;
        
        if (joy.active) { mx = joy.x; my = joy.y; }

        if (mx !== 0 || my !== 0) {
            const mag = Math.hypot(mx, my);
            const moveSpeed = mag > 1 ? player.speed : player.speed * mag;
            player.vx = (mx / mag) * moveSpeed;
            player.vy = (my / mag) * moveSpeed;
            player.x += player.vx;
            player.y += player.vy;
            player.angle = Math.atan2(my, mx);
        }

        // Camera Smooth Follow
        world.camera.tx = player.x - width/2;
        world.camera.ty = player.y - height/2;
        world.camera.x = MathUtils.lerp(world.camera.x, world.camera.tx, 0.1);
        world.camera.y = MathUtils.lerp(world.camera.y, world.camera.ty, 0.1);

        // --- ATTACK LOGIC ---
        if (player.cd_atk > 0) player.cd_atk--;
        if (player.invul > 0) player.invul--;
        player.mp = Math.min(player.maxMp, player.mp + player.stats.regenMp);

        // Auto Attack no PC se segurar Espa√ßo, ou Mobile btn
        if ((keys['Space'] || attackBtn.active) && player.cd_atk <= 0) {
            performAttack();
        }

        // --- ENTITIES ---
        // Spawn
        if (world.entities.length < CONFIG.ENEMY_LIMIT && frame % 30 === 0) {
            const ang = Math.random() * Math.PI * 2;
            const dist = CONFIG.SPAWN_RADIUS;
            const ex = player.x + Math.cos(ang) * dist;
            const ey = player.y + Math.sin(ang) * dist;
            
            // Escolha de tipo baseada no n√≠vel/tempo
            let type = 'grunt';
            if (state.level > 3 && Math.random() < 0.2) type = 'runner';
            if (state.level > 5 && Math.random() < 0.1) type = 'tank';
            
            world.entities.push(new Enemy(ex, ey, type));
        }

        // Update Inimigos
        world.entities.forEach(en => en.update());
        
        // Remove mortos e distantes
        world.entities = world.entities.filter(en => {
            if (en.dead) return false;
            if (MathUtils.dist(player.x, player.y, en.x, en.y) > CONFIG.DESPAWN_RADIUS && en.type !== 'boss') return false;
            return true;
        });

        // --- DROPS ---
        world.drops.forEach(d => {
            const dist = MathUtils.dist(player.x, player.y, d.x, d.y);
            if (dist < player.stats.magnet) {
                d.x = MathUtils.lerp(d.x, player.x, 0.15);
                d.y = MathUtils.lerp(d.y, player.y, 0.15);
                if (dist < 20) {
                    d.collected = true;
                    if(d.type === 'xp') {
                        state.xp += d.val;
                        if(state.xp >= state.nextXp) levelUp();
                    } else {
                        state.souls += d.val;
                    }
                }
            }
        });
        world.drops = world.drops.filter(d => !d.collected);

        // --- PARTICLES ---
        world.particles.forEach(p => p.update());
        world.particles = world.particles.filter(p => p.life > 0);
        if(world.particles.length > CONFIG.PARTICLE_LIMIT) world.particles.splice(0, 20);

        syncHUD();
    }

    function draw() {
        const cam = world.camera;
        
        // Shake
        let sx = 0, sy = 0;
        if(cam.shake > 0) {
            sx = MathUtils.rand(-cam.shake, cam.shake);
            sy = MathUtils.rand(-cam.shake, cam.shake);
            cam.shake *= 0.9;
            if(cam.shake < 0.5) cam.shake = 0;
        }

        // Background
        const biome = CONFIG.BIOMES[state.biomeIdx];
        ctx.fillStyle = biome.bg;
        ctx.fillRect(0, 0, width, height);

        ctx.save();
        ctx.translate(-cam.x + sx, -cam.y + sy);

        // Grid (Opcional, para no√ß√£o de movimento)
        ctx.strokeStyle = 'rgba(255,255,255,0.03)';
        ctx.lineWidth = 2;
        const gs = 200;
        const startX = Math.floor(cam.x / gs) * gs;
        const startY = Math.floor(cam.y / gs) * gs;
        // Desenha apenas o vis√≠vel
        ctx.beginPath();
        for(let x=startX; x<startX+width+gs; x+=gs) { ctx.moveTo(x, cam.y); ctx.lineTo(x, cam.y+height); }
        for(let y=startY; y<startY+height+gs; y+=gs) { ctx.moveTo(cam.x, y); ctx.lineTo(cam.x+width, y); }
        ctx.stroke();

        // Decals (Sangue)
        world.decals.forEach(d => {
            ctx.fillStyle = d.color;
            ctx.beginPath(); ctx.arc(d.x, d.y, d.r, 0, Math.PI*2); ctx.fill();
        });

        // Drops
        world.drops.forEach(d => {
            ctx.fillStyle = d.type === 'xp' ? '#3b82f6' : '#ffd700';
            ctx.beginPath(); ctx.arc(d.x, d.y, 4 + Math.sin(frame*0.1)*1, 0, Math.PI*2); ctx.fill();
            // Brilho
            ctx.shadowColor = ctx.fillStyle; ctx.shadowBlur = 10; ctx.stroke(); ctx.shadowBlur = 0;
        });

        // Entities
        world.entities.forEach(en => en.draw(ctx, {x:0, y:0})); // Passamos 0,0 pois ja traduzimos o contexto

        // Player
        if(player.invul % 8 < 4) { // Piscada de dano
            // Aura
            const grad = ctx.createRadialGradient(player.x, player.y, 10, player.x, player.y, 60);
            grad.addColorStop(0, player.weapon === 'staff' ? 'rgba(0,242,255,0.2)' : 'rgba(255,62,62,0.2)');
            grad.addColorStop(1, 'transparent');
            ctx.fillStyle = grad;
            ctx.beginPath(); ctx.arc(player.x, player.y, 60, 0, Math.PI*2); ctx.fill();

            // Corpo
            ctx.fillStyle = player.color;
            ctx.beginPath(); ctx.arc(player.x, player.y, player.radius, 0, Math.PI*2); ctx.fill();
            
            // Dire√ß√£o
            const ex = player.x + Math.cos(player.angle) * 10;
            const ey = player.y + Math.sin(player.angle) * 10;
            ctx.fillStyle = '#000';
            ctx.beginPath(); ctx.arc(ex, ey, 4, 0, Math.PI*2); ctx.fill();
        }

        // VFX Ataque
        if (player.cd_atk > (player.weapon === 'staff' ? 30 : 10)) {
            ctx.strokeStyle = player.weapon === 'staff' ? '#0ff' : '#f00';
            ctx.lineWidth = 3;
            ctx.beginPath();
            ctx.arc(player.x, player.y, player.stats.area * 100, player.angle - 1, player.angle + 1);
            ctx.stroke();
        }

        // Particles
        world.particles.forEach(p => p.draw(ctx, {x:0, y:0}));

        ctx.restore();
    }

    // --- A√á√ïES DO JOGO --- //

    function performAttack() {
        if(player.cd_atk > 0) return;
        
        player.cd_atk = player.weapon === 'staff' ? 45 : 20;
        const range = 120 * player.stats.area;
        
        // Efeito Visual
        world.camera.shake = 5;
        spawnParticles(player.x, player.y, '#fff', 5);

        // L√≥gica de Hit
        let hit = false;
        world.entities.forEach(en => {
            if(MathUtils.dist(player.x, player.y, en.x, en.y) < range + en.radius) {
                // C√°lculo de Cr√≠tico
                let dmg = player.dmg;
                let isCrit = Math.random() < player.stats.crit;
                if(isCrit) dmg *= 2.0;

                damageEnemy(en, dmg, isCrit);
                
                // Knockback
                const ang = Math.atan2(en.y - player.y, en.x - player.x);
                en.pushX = Math.cos(ang) * 10;
                en.pushY = Math.sin(ang) * 10;
                hit = true;
            }
        });

        // Som de ataque (simulado visualmente)
    }

    function damagePlayer(amount) {
        if(player.invul > 0) return;
        player.hp -= amount;
        player.invul = 40;
        world.camera.shake = 15;
        showFloater(player.x, player.y, `-${Math.floor(amount)}`, '#f00');
        spawnParticles(player.x, player.y, '#f00', 10);
        
        if(player.hp <= 0) gameOver();
    }

    function damageEnemy(en, amount, isCrit) {
        en.hp -= amount;
        showFloater(en.x, en.y, Math.floor(amount), isCrit ? '#ff0' : '#fff', isCrit);
        spawnParticles(en.x, en.y, en.color, 3);
        
        if(en.hp <= 0 && !en.dead) {
            en.dead = true;
            killEnemy(en);
        }
    }

    function killEnemy(en) {
        state.kills++;
        spawnParticles(en.x, en.y, en.color, 15);
        world.decals.push({x: en.x, y: en.y, r: en.radius, color: 'rgba(100,0,0,0.3)'});
        
        // Drops (XP e Almas)
        const xpAmount = Math.floor(en.xp * (1 + player.stats.luck * 0.5));
        world.drops.push({x: en.x, y: en.y, type: 'xp', val: xpAmount, collected: false});
        
        if (Math.random() < 0.3) {
            world.drops.push({x: en.x, y: en.y, type: 'soul', val: en.souls, collected: false});
        }

        // Lifesteal
        if(player.stats.lifesteal > 0) {
            player.hp = Math.min(player.maxHp, player.hp + player.stats.lifesteal);
        }

        if(en.type === 'boss') {
            state.bossActive = false;
            document.getElementById("boss-hud").classList.remove("visible");
            showToast("ARAUTO CA√çDO!");
            state.difficulty += 0.5;
            state.souls += 1000;
        }
    }

    function castSkill(slot) {
        const costs = [0, 30, 45, 60, 80, 100]; // Slot 0 vazio
        const cost = costs[slot];
        if(!cost) return;

        if(player.mp < cost) {
            showToast("MANA INSUFICIENTE");
            return;
        }

        player.mp -= cost;
        world.camera.shake = 20;

        switch(slot) {
            case 1: // Nova Explosiva
                world.entities.forEach(en => {
                    if(MathUtils.dist(player.x, player.y, en.x, en.y) < 300) damageEnemy(en, 150, true);
                });
                spawnParticles(player.x, player.y, '#0ff', 50);
                break;
            case 2: // Blitz (Speed)
                player.speed *= 2;
                player.invul = 60;
                setTimeout(() => player.speed /= 2, 2000);
                showToast("VELOCIDADE DA LUZ");
                break;
            case 3: // Cura
                player.hp = Math.min(player.maxHp, player.hp + player.maxHp * 0.4);
                spawnParticles(player.x, player.y, '#0f0', 30);
                break;
            case 4: // V√≥rtex
                world.entities.forEach(en => {
                    const ang = Math.atan2(player.y - en.y, player.x - en.x);
                    en.pushX = Math.cos(ang) * 20;
                    en.pushY = Math.sin(ang) * 20;
                    en.frozen = 120;
                });
                break;
            case 5: // Apocalipse
                world.entities.forEach(en => damageEnemy(en, 9999, true));
                // Matar Boss instantaneamente √© roubado, vamos limitar
                state.souls += 100;
                break;
        }
    }

    // --- UI E SISTEMAS --- //

    function showFloater(x, y, text, color, big=false) {
        const el = document.createElement('div');
        el.className = 'floater';
        el.style.left = (x - world.camera.x + width/2) + 'px'; // Aproxima√ß√£o, idealmente projetar coord
        // Como o canvas ocupa tudo e a c√¢mera move o desenho, precisamos calcular posi√ß√£o na tela
        // Corre√ß√£o r√°pida: Floaters HTML n√£o seguem a c√¢mera. 
        // Vamos usar um m√©todo simples: s√≥ spawnar no centro relativo
        // Melhor: Desenhar texto no Canvas √© mais perform√°tico.
        // Vou manter simples: n√£o implementar floaters HTML complexos agora para n√£o bugar a posi√ß√£o.
        // Vamos desenhar no Canvas no loop de draw se quisermos, mas o user pediu linha de c√≥digo.
        // Vou implementar um sistema simples de array de floaters desenhados no canvas.
        world.floaters.push({x, y, text, color, life: 60, big});
    }

    function spawnParticles(x, y, color, count) {
        for(let i=0; i<count; i++) world.particles.push(new Particle(x, y, color, MathUtils.rand(2, 6), 60));
    }

    function levelUp() {
        state.level++;
        state.xp = 0;
        state.nextXp = Math.floor(state.nextXp * 1.3);
        state.difficulty += 0.1;
        showToast("N√çVEL " + state.level);

        // Pausa e abre menu
        state.paused = true;
        const menu = document.getElementById("menu-upgrade");
        const root = document.getElementById("upgrade-root");
        menu.classList.remove("hidden");
        root.innerHTML = "";

        // Gerar 3 op√ß√µes aleat√≥rias
        const upgrades = [
            {t:"For√ßa Bruta", d:"+15% Dano", f:()=>player.dmg*=1.15},
            {t:"Vitalidade", d:"+50 Vida M√°x", f:()=>{player.maxHp+=50; player.hp+=50;}},
            {t:"Agilidade", d:"+10% Velocidade", f:()=>player.speed*=1.1},
            {t:"Vampirismo", d:"+2 Lifesteal", f:()=>player.stats.lifesteal+=2},
            {t:"√Årea de Efeito", d:"+20% Alcance", f:()=>player.stats.area+=0.2},
            {t:"Sabedoria", d:"+20% Regen Mana", f:()=>player.stats.regenMp*=1.2}
        ];

        // Shuffle e pegar 3
        upgrades.sort(()=>Math.random()-0.5).slice(0,3).forEach(u => {
            const el = document.createElement("div");
            el.className = "card-item";
            el.innerHTML = `<h3>${u.t}</h3><p>${u.d}</p><span style='color:lime'>ESCOLHER</span>`;
            el.onclick = () => {
                u.f();
                menu.classList.add("hidden");
                state.paused = false;
            };
            root.appendChild(el);
        });

        if(state.level % 5 === 0) spawnBoss();
    }

    function spawnBoss() {
        state.bossActive = true;
        const boss = new Enemy(player.x + 600, player.y, 'boss');
        world.entities.push(boss);
        
        const hud = document.getElementById("boss-hud");
        hud.classList.add("visible");
        document.getElementById("boss-name").innerText = "LORDE DAS SOMBRAS";
        showToast("UMA PRESEN√áA MALIGNA SURGIU");
    }

    function gameOver() {
        state.running = false;
        bgm.pause(); bgm.currentTime = 0;
        document.getElementById("menu-death").classList.remove("hidden");
        document.getElementById("death-stats").innerText = 
            `N√çVEL: ${state.level} ‚Ä¢ ABATES: ${state.kills} ‚Ä¢ ALMAS: ${state.souls}`;
    }

    function syncHUD() {
        document.getElementById("hp-bar").style.width = (player.hp / player.maxHp * 100) + "%";
        document.getElementById("mp-bar").style.width = (player.mp / player.maxMp * 100) + "%";
        document.getElementById("xp-bar").style.width = (state.xp / state.nextXp * 100) + "%";
        
        document.getElementById("hp-val").innerText = Math.floor(player.hp) + "/" + Math.floor(player.maxHp);
        document.getElementById("mp-val").innerText = Math.floor(player.mp) + "/" + Math.floor(player.maxMp);
        document.getElementById("xp-val").innerText = Math.floor(state.xp) + "/" + Math.floor(state.nextXp);
        
        document.getElementById("lvl-txt").innerText = state.level;
        document.getElementById("kills-txt").innerText = state.kills;
        document.getElementById("coins-txt").innerText = state.souls;
        document.getElementById("bioma-name").innerText = CONFIG.BIOMES[state.biomeIdx].name;

        // Atualizar Boss Bar
        if(state.bossActive) {
            const boss = world.entities.find(e => e.type === 'boss');
            if(boss) document.getElementById("boss-bar").style.width = (boss.hp / boss.maxHp * 100) + "%";
        }

        // Draw Floaters in HUD sync (draw call actually better inside draw loop, but keeping separate logic here if needed)
        // Vamos desenhar floaters dentro do loop draw() para ficarem corretos na tela
    }
    
    // Sobrescrevendo o draw final para incluir floaters (textos de dano)
    const originalDraw = draw;
    draw = function() {
        originalDraw();
        const ctx = canvas.getContext("2d");
        const cam = world.camera;
        
        ctx.save();
        ctx.font = "bold 20px Arial";
        ctx.textAlign = "center";
        
        world.floaters.forEach(f => {
            const sx = f.x - cam.x;
            const sy = f.y - cam.y;
            // Float up animation logic
            const offset = (60 - f.life) * 1.5;
            
            ctx.fillStyle = 'black';
            ctx.fillText(f.text, sx + 2, sy - offset + 2);
            ctx.fillStyle = f.color;
            if(f.big) ctx.font = "bold 30px Arial";
            ctx.fillText(f.text, sx, sy - offset);
            
            f.life--;
        });
        world.floaters = world.floaters.filter(f => f.life > 0);
        ctx.restore();
    }

    function toggleShop() {
        const menu = document.getElementById("menu-shop");
        if (menu.classList.contains("hidden")) {
            state.paused = true;
            menu.classList.remove("hidden");
            renderShop();
        } else {
            state.paused = false;
            menu.classList.add("hidden");
        }
    }

    function renderShop() {
        const root = document.getElementById("shop-root");
        root.innerHTML = "";
        CONFIG.SHOP_ITEMS.forEach(item => {
            const el = document.createElement("div");
            el.className = "card-item";
            el.innerHTML = `
                <h3>${item.name}</h3>
                <p>${item.desc}</p>
                <span class="card-price">${item.cost} ALMAS</span>
            `;
            el.onclick = () => {
                if(state.souls >= item.cost) {
                    state.souls -= item.cost;
                    item.fn(player);
                    showToast("COMPRADO: " + item.name);
                    renderShop(); // Atualiza (se quiser aumentar pre√ßo, etc)
                    syncHUD();
                } else {
                    showToast("ALMAS INSUFICIENTES");
                }
            };
            root.appendChild(el);
        });
    }

    function showToast(msg) {
        const t = document.getElementById("toast");
        t.innerText = msg;
        t.style.opacity = 1;
        setTimeout(() => t.style.opacity = 0, 2000);
    }

    // --- CONFIGURA√á√ïES ---
    function toggleSettings() {
        const m = document.getElementById("menu-settings");
        m.classList.toggle("hidden");
    }

    function resizeJoystick(val) {
        const zone = document.getElementById("joy-zone-left");
        zone.style.width = val + "px";
        zone.style.height = val + "px";
    }

    function toggleFullscreen() {
        if (!document.fullscreenElement) {
            document.documentElement.requestFullscreen().catch(e => console.log(e));
        } else {
            document.exitFullscreen();
        }
    }
    
    function setVolume(val) {
        bgm.volume = val / 100;
    }

    // Init
    window.onload = () => {
        resize();
        initInput();
        window.addEventListener('resize', resize);
    };

    return { 
        startGame, 
        toggleShop, 
        toggleSettings, 
        toggleFullscreen,
        resizeJoystick,
        setVolume,
        cast: castSkill,
        damagePlayer,
        damageEnemy
    };
})();
</script>
</body>
</html>
